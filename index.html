<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>2026 å¹´ 1æœˆ æ–°ç•ªå¯¼è§†</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* æ–°å¢æ§åˆ¶æ æ ·å¼ */
        header { display: flex; flex-direction: column; gap: 15px; }
        header h1 { margin: 0; }
        header .header-bottom { display: flex; flex-direction: column; gap: 15px; }
        .controls { display: flex; width: 100%; flex-direction: column; gap: 15px; padding: 20px; background: var(--card); border-radius: 12px; }
        .controls > div { text-align: left; }
        .controls strong { display: block; margin-bottom: 8px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; }
        .filter-btn { padding: 6px 14px; border: none; background: #334155; color: #94a3b8; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .filter-btn.active { background: var(--accent); color: var(--bg); font-weight: bold; }
        .sort-group { display: flex; align-self: flex-end; background: var(--card); padding: 15px 20px; border-radius: 12px; }
        .sort-group select { padding: 8px; background: var(--card); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; }
        .summary { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; word-wrap: break-word; max-height: 3em; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            header { gap: 12px; }
            header h1 { font-size: 1.8rem; }
            header .header-bottom { flex-direction: column; gap: 12px; }
            .controls { gap: 12px; padding: 15px; }
            .controls > div { margin-bottom: 0; }
            .controls strong { margin-bottom: 6px; font-size: 0.95rem; }
            .filter-group { gap: 6px; overflow-x: auto; padding-bottom: 8px; }
            .filter-group::-webkit-scrollbar { height: 0; }
            .filter-group::-webkit-scrollbar-thumb { background: transparent; }
            .filter-btn { padding: 5px 10px; font-size: 0.85rem; white-space: nowrap; flex-shrink: 0; }
            .sort-group select { padding: 6px; font-size: 0.9rem; }
        }
        
        @media (max-width: 480px) {
            body { padding: 1rem; }
            header h1 { font-size: 1.5rem; }
            .controls { gap: 10px; padding: 12px; }
            .controls strong { font-size: 0.9rem; }
            .filter-btn { padding: 4px 8px; font-size: 0.8rem; }
            .filter-group { gap: 5px; }
            .sort-group select { width: 100%; padding: 6px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="font-size: 0.85rem; color: #888; margin-bottom: 8px;">
                æ•°æ®æºï¼š<a href="https://bgm.tv" target="_blank" style="color: #888; text-decoration: none;">Bangumi ç•ªç»„è®¡åˆ’</a> | æœ€æ–°æ›´æ–°ï¼š<span id="data-update-time" style="color: #aaa;">åŠ è½½ä¸­...</span>
            </div>
            <h1>2026 å¹´ 1 æœˆ æ–°ç•ªå¯¼è§†</h1>
            <div class="header-bottom">
                <div class="controls">
                    <div>
                        <strong>å‡ºå¤„ç­›é€‰</strong>
                        <div class="filter-group" id="origin-filter">
                            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div>
                        <strong>æ ‡ç­¾ç­›é€‰</strong>
                        <div class="filter-group" id="tag-filter">
                            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                        </div>
                    </div>
                </div>
                <div class="sort-group">
                    <select id="sort-select">
                        <option value="wish">æŒ‰å…³æ³¨åº¦ (æƒ³çœ‹äººæ•°)</option>
                        <option value="score">æŒ‰è¯„åˆ†æ’åº</option>
                    </select>
                </div>
            </div>
        </header>

        <main class="anime-grid" id="anime-grid">
            <!-- åŠ¨æ€åŠ è½½çš„å¡ç‰‡å†…å®¹ -->
        </main>
    </div>

    <script>
        let allAnimeData = [];
        let selectedOrigin = 'all';
        let selectedTag = 'all';

        // ä» JSON åŠ è½½æ•°æ®å¹¶åˆå§‹åŒ–
        async function loadData() {
            try {
                const response = await fetch('./anime_data.json');
                const json = await response.json();
                
                // å¤„ç†æ–°æ ¼å¼ï¼š{ lastUpdated, items }
                let data = json.items || json;
                let lastUpdated = json.lastUpdated || 'æœªçŸ¥';
                
                // æ˜¾ç¤ºæœ€æ–°æ›´æ–°æ—¶é—´
                document.getElementById('data-update-time').textContent = lastUpdated;
                
                // è¿‡æ»¤æ•°æ®ï¼šairDate >= 2026-01-01 ä¸”ä¸åŒ…å« "å‰§åœºç‰ˆ"
                allAnimeData = data.filter(anime => {
                    const airDate = anime.airDate || '';
                    const hasExcludedTag = anime.metaTags && anime.metaTags.some(tag => tag.includes('å‰§åœºç‰ˆ'));
                    return airDate >= '2026-01-01' && !hasExcludedTag;
                });
                
                // æå–å¹¶ç”Ÿæˆç­›é€‰æŒ‰é’®
                generateFilterButtons();
                
                // æ¸²æŸ“æ‰€æœ‰å¡ç‰‡
                renderCards();
                
                // ç»‘å®šç­›é€‰äº‹ä»¶
                attachFilterListeners();
                
                // ç»‘å®šæ’åºäº‹ä»¶
                attachSortListener();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('anime-grid').innerHTML = '<p style="text-align: center; color: var(--text);">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            }
        }

        // æå–å¹¶ç”Ÿæˆç­›é€‰æŒ‰é’®
        function generateFilterButtons() {
            const origins = new Set();
            const tags = new Set();
            
            allAnimeData.forEach(anime => {
                if (anime.origin) origins.add(anime.origin);
                if (anime.metaTags) anime.metaTags.forEach(tag => tags.add(tag));
            });
            
            // æ·»åŠ å‡ºå¤„æŒ‰é’®
            const originFilter = document.getElementById('origin-filter');
            const originBtns = Array.from(origins);
            originBtns.forEach(origin => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.dataset.filter = origin;
                btn.textContent = origin;
                originFilter.appendChild(btn);
            });
            
            // æ·»åŠ æ ‡ç­¾æŒ‰é’®
            const tagFilter = document.getElementById('tag-filter');
            const displayTags = Array.from(new Set([...origins,...tags]));
            const tagBtns = Array.from(tags);
            tagBtns.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.dataset.filter = tag;
                btn.textContent = tag;
                tagFilter.appendChild(btn);
            });
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards(filtered = null) {
            const grid = document.getElementById('anime-grid');
            const dataToRender = filtered || allAnimeData;
            
            grid.innerHTML = dataToRender.map(anime => {
                // åˆå¹¶ origin å’Œ metaTagsï¼Œç”Ÿæˆç”¨äºç­›é€‰çš„æ•°æ®å±æ€§
                const allTags = [];
                if (anime.origin) allTags.push(anime.origin);
                if (anime.metaTags && anime.metaTags.length) allTags.push(...anime.metaTags);
                const uniqueTags = Array.from(new Set(allTags.filter(t => t)));
                
                return `
                <div class="card" 
                     data-wish="${anime.wish || 0}" 
                     data-score="${anime.score || 0}"
                     data-origin="${anime.origin || ''}"
                     data-tags="${uniqueTags.join('|')}">
                    
                    <div class="poster-wrapper">
                        <img class="poster" src="${anime.cover || ''}" loading="lazy" alt="${anime.titleCN || anime.title}">
                        <div class="score-badge">â˜… ${anime.score || 0}</div>
                    </div>

                    <div class="info">
                        <h3 class="title" title="${anime.titleCN || anime.title}">
                            <span class="title-cn">${anime.titleCN || anime.title}</span>
                            ${anime.titleJP ? `<span class="title-jp">${anime.titleJP}</span>` : ''}
                        </h3>
                        
                        <div class="meta">
                            <span>ğŸ“… ${anime.airDate || ''}</span>
                            <span>ğŸ”¥ ${anime.wish || 0} äººæƒ³çœ‹</span>
                        </div>

                        <div class="staff-info">
                            ${anime.staff ? anime.staff.map(s => `<p><strong>${s.role}:</strong> ${s.name}</p>`).join('') : ''}
                        </div>

                        <p class="summary">${anime.summary || ''}</p>
                        <div class="tags">
                            ${uniqueTags.map(tag => `<span class="tag meta-tag">${tag}</span>`).join('')}
                        </div>
                        
                        <div class="resource-links">
                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(anime.titleCN || anime.title)} PV Official Trailer" target="_blank" title="æœç´¢ PV">ğŸ¬ PV</a>
                            ${anime.officialWebsite ? `<a href="${anime.officialWebsite}" target="_blank" title="å®˜æ–¹ç½‘ç«™">ğŸŒ å®˜ç½‘</a>` : ''}
                            ${anime.bangumiId ? `<a href="https://bgm.tv/subject/${anime.bangumiId}" target="_blank" title="Bangumi é¡µé¢">ğŸ“º Bangumi</a>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // è¿‡æ»¤é€»è¾‘
        function applyFilters() {
            const filtered = allAnimeData.filter(anime => {
                const matchOrigin = selectedOrigin === 'all' || anime.origin === selectedOrigin;
                const matchTag = selectedTag === 'all' || (anime.metaTags && anime.metaTags.includes(selectedTag));
                return matchOrigin && matchTag;
            });
            
            renderCards(filtered);
            performSort();
        }

        // æ’åºé€»è¾‘
        function performSort() {
            const sortSelect = document.getElementById('sort-select');
            const sortBy = sortSelect.value;
            const cards = document.querySelectorAll('.card');
            const cardsArray = Array.from(cards);
            
            cardsArray.sort((a, b) => {
                const valA = parseFloat(a.dataset[sortBy]) || 0;
                const valB = parseFloat(b.dataset[sortBy]) || 0;
                return valB - valA;
            });
            
            const grid = document.getElementById('anime-grid');
            cardsArray.forEach(card => grid.appendChild(card));
        }

        // ç»‘å®šç­›é€‰äº‹ä»¶
        function attachFilterListeners() {
            const originFilterBtns = document.querySelectorAll('#origin-filter .filter-btn');
            const tagFilterBtns = document.querySelectorAll('#tag-filter .filter-btn');
            
            originFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    originFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedOrigin = btn.dataset.filter;
                    applyFilters();
                });
            });
            
            tagFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tagFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedTag = btn.dataset.filter;
                    applyFilters();
                });
            });
        }

        // ç»‘å®šæ’åºäº‹ä»¶
        function attachSortListener() {
            const sortSelect = document.getElementById('sort-select');
            performSort();
            sortSelect.addEventListener('change', performSort);
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
